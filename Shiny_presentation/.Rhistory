sep="")
stopifnot(grepl(dateRegex, fileName))
fileDate<-regmatches(fileName,
regexpr(dateRegex, fileName))
return(list(stYear=as.integer(substr(fileDate, 1, 4)),
stMonth=as.integer(substr(fileDate, 5, 6))
))
#	return(as.integer(substr(fileDate, 1, 4)))
}
# opts_knit$set(root.dir="D:/Card statements/Citi")
tyPremierDir<-"Citi/ThankYou Premier_WorldElite MasterCard_1065/"
doubleCashDir<-"Citi/DoubleCash_MasterCard_9945/"
rmExtraSpaces<-function(str)	{
firstLine<-unlist(strsplit(str, "\n"))[1]
spaces<-unlist(strsplit(firstLine, " "))
fSpaces<-Filter(function(str) nchar(str) > 0, spaces)
return(paste(fSpaces, collapse=" "))
}
# isNewInterface TRUE for Jul 2018 and beyond
processCitiCSV<-function(rootDir, fn, isNewInterface=TRUE)	{
fullName<-paste(rootDir, fn, sep="")
# fn<-paste(tyPremierDir,
#           "Transactions ending_20180323",
#           tyPremierTail,
#           sep="")
initialDF<-read.csv(fullName,header=TRUE,stringsAsFactors=FALSE)
cleanedDesc<-unlist(lapply(seq(nrow(initialDF)),
function(k) rmExtraSpaces(
initialDF$Description[k])
)
)
if(isNewInterface)  {
initialDF<-initialDF %>%
mutate(Amt=ifelse(is.na(Debit), Credit, Debit))
}
else  {
initialDF<-initialDF %>%
mutate(Amt=ifelse(is.na(Debit), Credit, Debit))
}
res<-data.frame(Date=as.Date(initialDF$Date, format="%m/%d/%Y"),
Desc=cleanedDesc,
Amount=unlist(initialDF %>% select(Amt)))
row.names(res)<-NULL
write.csv(res,
paste("Citi/Processed files/",
"Processed ",
fn,
sep=""),
row.names=FALSE)
return(0)
}
tyPremierTail<-"_Citi_ThankYouPremier_WorldEliteMastercard_1065.csv"
doubleCashTail<-"_Citi_DoubleCash_Mastercard_9945.csv"
processCitiCSV(tyPremierDir,
paste("Transactions ending_20180823",
tyPremierTail,
sep=""))
# processCitiCSV(doubleCashDir,
#                paste("Transactions ending_20180725",
#                      doubleCashTail,
#                      sep=""))
library(knitr)
library(readtext)
library(dplyr)
opts_knit$set(root.dir="D:/Card statements")
getYM<-function(fileName)	{
dateRegex<-paste("[1-9]{1}[[:digit:]]{3}[0-1]{1}[[:digit:]]{1}[0-3]{1}",
"[[:digit:]]{1}",
sep="")
stopifnot(grepl(dateRegex, fileName))
fileDate<-regmatches(fileName,
regexpr(dateRegex, fileName))
return(list(stYear=as.integer(substr(fileDate, 1, 4)),
stMonth=as.integer(substr(fileDate, 5, 6))
))
#	return(as.integer(substr(fileDate, 1, 4)))
}
extractFieldsChase<-function(txt)	{
txt<-gsub("([[:digit:]]+)\\,([[:digit:]])", "\\1\\2", txt)
dateRegex<-"[0-1]{1}[[:digit:]]{1}\\/[0-3]{1}[[:digit:]]{1}"
amtRegex<-"\\-?[[:digit:]]*\\.[[:digit:]]{2}"
stopifnot(grepl(dateRegex,txt))
stopifnot(grepl(amtRegex,txt))
amtMatchObj<-regexpr(amtRegex,txt)
return(data.frame(MMDD=regmatches(txt, regexpr(dateRegex,txt)),
Desc=substr(txt,
7,
amtMatchObj[1]-2),
Amt=as.numeric(regmatches(txt, amtMatchObj))
))
}
processLinesChase<-function(dir)	{
df_txt<-readtext(dir)
processMonth<-function(k)  {
stYM<-getYM(df_txt$doc_id[k])
lines<-unlist(strsplit(df_txt$text[k], "\n"))
res<-do.call(rbind,
lapply(seq(length(lines)),
function(j)
extractFieldsChase(lines[j]))
)
res<-res %>%
mutate(Month=as.integer(substr(MMDD,1,2))) %>%
mutate(TransactionDate=
as.Date(paste(ifelse(stYM$stMonth==1 &
Month==12,
stYM$stYear-1,
stYM$stYear),
substr(MMDD,1,2),
substr(MMDD,4,5),
sep="-")),
Statement=k) %>%
select(Statement,TransactionDate, Desc, Amt)
return(res)
}
return(
do.call(rbind,
lapply(seq(nrow(df_txt)),
processMonth))
)
}
folderUA<-"Chase/United MileagePlus Explorer_Visa Signature 1598/"
mpeDF<-processLinesChase(paste(folderUA,
"TXT reductions/*",
sep=""))
csp_cfDF<-processLinesChase(paste("Chase/Freedom",
"_Visa Signature 3696/TXT reductions/*",
sep=""))
hyattDF<-processLinesChase("Chase/Hyatt_Visa Signature 3206/TXT reductions/*")
write.csv(mpeDF,
paste("Combined transactions Chase_United MileagePlus Explorer",
"_Visa Signature 1598.csv",
sep=""),
row.names=FALSE)
write.csv(csp_cfDF,
paste("Combined transactions Chase_Freedom (formerly ",
"Sapphire Preferred)",
"_Visa Signature 3696.csv",
sep=""),
row.names=FALSE)
write.csv(hyattDF,
"Combined transactions Hyatt_Visa Signature 3206.csv",
row.names=FALSE)
library(knitr)
library(readtext)
library(dplyr)
opts_knit$set(root.dir="D:/Card statements")
getYM<-function(fileName)	{
dateRegex<-paste("[1-9]{1}[[:digit:]]{3}[0-1]{1}[[:digit:]]{1}[0-3]{1}",
"[[:digit:]]{1}",
sep="")
stopifnot(grepl(dateRegex, fileName))
fileDate<-regmatches(fileName,
regexpr(dateRegex, fileName))
return(list(stYear=as.integer(substr(fileDate, 1, 4)),
stMonth=as.integer(substr(fileDate, 5, 6))
))
#	return(as.integer(substr(fileDate, 1, 4)))
}
extractFieldsBoA<-function(txt) {#, isCashRewards)	{
# txt<-
dateRegex<-"[0-1]{1}[[:digit:]]{1}\\/[0-3]{1}[[:digit:]]{1}"
amtRegex<-"\\-?[[:digit:]]*\\.[[:digit:]]{2}"
codeRegex<-"([[:digit:]]{2}[A-Z0-9]{2})? ([[:digit:]]{4}|(Virtual Card)){1}"
stopifnot(grepl(paste(dateRegex,
dateRegex,
sep=" "),
txt))
stopifnot(grepl(amtRegex,txt))
stopifnot(grepl(codeRegex,txt))
# txt<-gsub(",","",txt)
decodedTxt<-gsub(codeRegex,"",txt)
decodedTxt<-gsub("([[:digit:]]+)\\,([[:digit:]])", "\\1\\2", decodedTxt)
dateMatchesObj<-gregexpr(dateRegex,decodedTxt)
stopifnot(length(dateMatchesObj[[1]])==2)
dateMatches<-unlist(regmatches(decodedTxt, dateMatchesObj))
txtDesc<-gsub(amtRegex,"",
gsub(dateRegex,"",decodedTxt))
return(data.frame(TransMMDD=dateMatches[1],
PostMMDD=dateMatches[2],
Desc=trimws(txtDesc),
Amt=as.numeric(regmatches(decodedTxt,
gregexpr(amtRegex, decodedTxt)
)
)
))
}
processLinesBoA<-function(dir)	{
# dir<-paste("Bank of America/Better Balance Rewards",
#                            "_MasterCard_4469/TXT reductions/*",
#                            sep="")
df_txt<-readtext(dir)
processMonth<-function(k)  {
stYM<-getYM(df_txt$doc_id[k])
lines<-unlist(strsplit(df_txt$text[k], "\n"))
res<-do.call(rbind,
lapply(seq(length(lines)),
function(j)
extractFieldsBoA(lines[j]))
)
fullDate<-function(str)	{
stopifnot(grepl("[0-1]{1}[[:digit:]]{1}\\/[0-3]{1}[[:digit:]]{1}",
str))
month<-substr(str,1,2)
return(
as.Date(paste(ifelse(stYM$stMonth==1 &
month==12,
stYM$stYear-1,
stYM$stYear),
month,
substr(str,4,5),
sep="-"))
)
}
res<-res %>%
mutate(TransactionDate=fullDate(TransMMDD),
PostDate=fullDate(PostMMDD),
Statement=k) %>%
select(Statement,TransactionDate, PostDate, Desc, Amt)
return(res)
}
return(
do.call(rbind,
lapply(seq(nrow(df_txt)),
processMonth))
)
}
crDF<-processLinesBoA(paste("Bank of America/Cash Rewards_Visa Signature_7509",
"/TXT reductions/*",
sep=""))
# bbrDF<-processLinesBoA(paste("Bank of America/Better Balance Rewards",
#                              "_MasterCard_4469/TXT reductions/*",
#                              sep=""))
write.csv(crDF,
paste("Combined transactions BoA_Cash Rewards_Visa Signature_",
"7509.csv",
sep=""),
row.names=FALSE)
# write.csv(bbrDF,
#           paste("Combined transactions BoA_Better Balance Rewards_MasterCard_",
#                 "4469.csv",
#                 sep=""),
#           row.names=FALSE)
library(plotly)
plot_ly(mtcars, x = ~wt, y = ~mpg, type = "scatter")
plot_ly(mtcars, x = ~wt, y = ~mpg, type = "scatter", color = ~factor(cyl))
plot_ly(mtcars, x = ~wt, y = ~mpg, type = "scatter", color = ~disp)
plot_ly(mtcars, x = ~wt, y = ~mpg, type = "scatter",
color = ~factor(cyl), size = ~hp)
set.seed(2016-07-21)
temp <- rnorm(100, mean = 30, sd = 5)
pressue <- rnorm(100)
dtime <- 1:100
plot_ly(x = ~temp, y = ~pressue, z = ~dtime,
type = "scatter3d", color = ~temp)
data("airmiles")
plot_ly(x = ~time(airmiles), y = ~airmiles, type = "scatter", mode = "lines")
library(plotly)
library(tidyr)
library(dplyr)
data("EuStockMarkets")
stocks <- as.data.frame(EuStockMarkets) %>%
gather(index, price) %>%
mutate(time = rep(time(EuStockMarkets), 4))
plot_ly(stocks, x = ~time, y = ~price, color = ~index, type = "scatter", mode = "lines")
plot_ly(x = ~precip, type = "histogram")
plot_ly(iris, y = ~Petal.Length, color = ~Species, type = "box")
terrain1 <- matrix(rnorm(100*100), nrow = 100, ncol = 100)
plot_ly(z = ~terrain1, type = "heatmap")
terrain2 <- matrix(sort(rnorm(100*100)), nrow = 100, ncol = 100)
plot_ly(z = ~terrain2, type = "surface")
terrain2 <- matrix(sort(rnorm(100*100)), nrow = 100, ncol = 100)
plot_ly(z = ~terrain2, type = "surface")
# Create data frame
state_pop <- data.frame(State = state.abb, Pop = as.vector(state.x77[,1]))
# Create hover text
state_pop$hover <- with(state_pop, paste(State, '<br>', "Population:", Pop))
# Make state borders white
borders <- list(color = toRGB("red"))
# Set up some mapping options
map_options <- list(
scope = 'usa',
projection = list(type = 'albers usa'),
showlakes = TRUE,
lakecolor = toRGB('white')
)
plot_ly(z = ~state_pop$Pop, text = ~state_pop$hover, locations = ~state_pop$State,
type = 'choropleth', locationmode = 'USA-states',
color = state_pop$Pop, colors = 'Blues', marker = list(line = borders)) %>%
layout(title = 'US Population in 1975', geo = map_options)
plot
_ly (
type = 'scattergeo' ,
lon =
c( 42, 39 ) ,
lat =
c( 12, 22 ) ,
text =
c( 'one' , 'two' ) ,
mode = 'markers' )
plot_ly (
type = 'scattergeo' ,
lon =
c( 42, 39 ) ,
lat =
c( 12, 22 ) ,
text =
c( 'one' , 'two' ) ,
mode = 'markers' )
plot_ly (
type = 'scattergeo' ,
lat =
c( 42, 39 ) ,
lon =
c( 12, 22 ) ,
text =
c( 'one' , 'two' ) ,
mode = 'markers' )
?volcano
?plot_ly
plot_ly (
type = 'scattergeo' ,
lat =
c( 38.909, 38.86 ) ,
lon =
c( -77.549, -77.04 ) ,
text =
c( 'one' , 'two' ) ,
mode = 'markers' )
plot_ly(type = 'heatmap', z=volcano)
shiny::runApp('C:/HY/Coursera/DS/9 Developing Data Products/Examples/Shiny Part I/Interactive_scatter')
runApp('C:/HY/Coursera/DS/9 Developing Data Products/Examples/Shiny Part II/Girth_interactive')
runApp('C:/HY/Coursera/DS/9 Developing Data Products/Week 2 Leaflet/Metrorail_stations_by_opening_time')
setwd("C:/HY/Projects/Washington_Metro_leaflet")
library(data.table)
library(dplyr)
setwd("C:/HY/Projects/Washington_Metro_leaflet")
# Assumes query_wmata_stations.py has been run, outputting a .CSV file
prep<-function(fn)  {
stopifnot(grepl("\\.csv$", fn))
dfFullStation<-read.csv(fn, header=TRUE, stringsAsFactors = FALSE)
colTypes<-sapply(seq(ncol(dfFullStation)),
function(k) typeof(dfFullStation[,k]))
idxList<-which(colTypes=="list")
dfFullStation[,idxList]<-gsub("NULL",as.character(NA),
sapply(idxList, function(k)
unlist(as.character(dfFullStation[,k]))))
blankToNA<-function(s)  {
ifelse(s=="", as.character(NA), s)
}
dfFullStation<-dfFullStation %>%
mutate(LineCode2=blankToNA(LineCode2),
LineCode3=blankToNA(LineCode3),
StationTogether1=blankToNA(StationTogether1),
StationTogether2=blankToNA(StationTogether2))
dfRmDups<-dfFullStation %>%
as.data.table() %>%
setkey(Code) %>%
unique(by="Code") %>%
as.data.frame()
dfRmDups<-dfRmDups %>%
mutate(isUpperLevel=ifelse(is.na(StationTogether1),
-1,
ifelse(LineCode1=="RD",
TRUE,
ifelse(grepl("Enfant", Name) &
LineCode1 %in% c("GR", "YL"),
TRUE,
FALSE)
) %>% as.integer()
))
return(dfRmDups)
}
dfRmDups<-prep("api_stations.csv")
lookupCode<-function(df, stName, levelCode=-1)  {
stopifnot(levelCode %in% seq(-1,1))
dfPossible<-df %>%
filter(grepl(stName, Name))
bIncorrect<-(levelCode < 0 & any(dfPossible$isUpperLevel >= 0)) |
(levelCode >= 0 & any(dfPossible$isUpperLevel < 0))
stopifnot(!bIncorrect)
res<-df %>%
filter(isUpperLevel == levelCode & grepl(stName, Name)) %>%
select(Code) %>%
unlist()
stopifnot(length(res)==1)
return(res)
}
CODE_NOMA<-dfRmDups %>%
lookupCode("NoMa")
INFILL_STATIONS<-c(CODE_NOMA,
"C11") # Potomac Yard (BL & YL--future);
TERMINUS<-"TERMINUS"
# referenced from https://docs.google.com/spreadsheets/d/13Kz-v3Yjn6ork9vXyl8KLSgzf7KYuGNP9d7HPMd-Kzc/pub?hl=en&single=true&gid=0&output=html
linesByTravelOrder<-read.csv("api_lines_in_travel_order.csv", header=TRUE)
cName<-function(s)  {
s<-Filter(function(x) !is.na(x), s)
s<-gsub("(\\*|\\[[a-z]\\])", "", s)
s<-gsub("\\s*\\(.+\\)", "", s)
s<-gsub("[^A-z\\s\\']", " ", s)
s<-gsub("Mount", "Mt", s)
return(s)
}
cleanName<-Vectorize(cName, vectorize.args = "s")
eFirst<-function(s) {
words<-s %>%
cName() %>%
strsplit(" ") %>%
unlist()
return(words[1] %>% trimws())
}
extractFirst<-Vectorize(eFirst, vectorize.args = "s")
processOpenings<-function(fn) {
stopifnot(grepl("\\.csv$", fn))
openings<-read.csv(fn, header=T, stringsAsFactors=F)
openings<-openings %>%
mutate(Station = as.character(Station)) %>%
mutate(nameCleaned = cleanName(Station),
Opened=as.Date(Opened, format="%B %d, %Y"),
boolUpperLevel=ifelse(grepl("level\\s*\\)", Station),
grepl("[Uu]p", Station),
as.logical(NA)))
openings<-openings[order(openings$nameCleaned,
openings$boolUpperLevel),]
return(openings)
}
augmentStation<-function(dfOpenings, dfStations)  {
dfStations<-dfStations[order(dfStations$Name,
dfStations$isUpperLevel),]
namesApi<-extractFirst(dfStations$Name)
namesDL<-extractFirst(dfOpenings$Station)
sum(namesApi != namesDL)
res<-cbind(dfStations, dfOpenings)
cleanCols<-function(df) {
df<-df %>%
select(-c(Station, boolUpperLevel, nameCleaned))
idxNonNA<-apply(df, MARGIN=2, FUN = function(x) any(!is.na(x)))
df<-df %>%
select(names(df)[idxNonNA])
return(df)
}
res<-cleanCols(res)
res<-res[order(res$Code),]
res<-res %>%
select(-c(LineCode1, LineCode2, LineCode3, queriedLine))
return(res)
}
trimStations<-function(stationsWithOpenings)  {
dfMultiLevel<-stationsWithOpenings %>%
filter(isUpperLevel >= 0) %>%
arrange(Name, isUpperLevel)
splitMulti<-split(dfMultiLevel, dfMultiLevel$Name)
consolidateDF<-function(elt)  {
helper<-function(k) {
colName<-names(dfMultiLevel)[k]
if(colName %in% c("Lat", "Lon", "Name", "isUpperLevel",
"Lines", "Opened")) {
if(colName %in% c("Lat", "Lon"))
return(unique(elt[,k]))
else if(colName == "Name")  {
return(unique(elt$Name))
}
else if(colName == "isUpperLevel")
return(-1)
else if(colName == "Lines") {
res<-paste("Upper level: ", elt$Lines[2], "<br/>",
"Lower level: ", elt$Lines[1],
sep="")
return(res)
}
else
return(min(elt$Opened))
}
else
return(NA)
}
partialResults<-lapply(seq(ncol(dfMultiLevel)),
helper)
names(partialResults)<-names(dfMultiLevel)
return(partialResults %>% as.data.frame)
}
dfMultiLevel<-do.call(rbind,
lapply(splitMulti, consolidateDF))
dfSingleLevel<-stationsWithOpenings %>%
filter(isUpperLevel < 0)
res<-rbind(dfSingleLevel,
dfMultiLevel)
row.names(res)<-NULL
return(res)
}
augmentLines<-function(stationsWithOpenings, dfLines) {
res<-left_join(dfLines, stationsWithOpenings, by=c("StationCode"="Code"))
res<-res[order(res$LineCode,res$SeqNum),]
return(res)
}
openings<-processOpenings("Station opening time list.csv")
dfStations1<-augmentStation(openings, dfRmDups)
trimmedStations<-trimStations(dfStations1)
joinedLines<-augmentLines(dfStations1, linesByTravelOrder)
write.csv(trimmedStations, "concise_stations.csv", row.names = FALSE)
write.csv(joinedLines, "stations_line_travel_order.csv", row.names = FALSE)
slidify("index.Rmd")
library(slidify)
slidify("index.Rmd")
library(slidify)
slidify("index.md")
slidify("index.Rmd")
setwd("C:/HY/Projects/Washington_Metro_leaflet/Metrorail shiny presentation")
slidify("index.Rmd")
slidify("index.Rmd")
slidify("index.Rmd")
slidify("index.Rmd")
